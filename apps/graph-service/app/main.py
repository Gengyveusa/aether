from fastapi import FastAPI, HTTPException
from typing import Any, Dict, Optional
from jsonschema import Draft7Validator
from .schema_loader import load_schema
import uuid
from datetime import datetime, timezone

app = FastAPI(title="Aether Graph Service", version="0.0.0")

# Load schemas (generated by packages/shared-types)
ENTITY_SCHEMA = load_schema("Entity")
RELATIONSHIP_SCHEMA = load_schema("Relationship")
CANONICAL_CONTENT_SCHEMA = load_schema("CanonicalContent")

entity_validator = Draft7Validator(ENTITY_SCHEMA)
relationship_validator = Draft7Validator(RELATIONSHIP_SCHEMA)
canonical_content_validator = Draft7Validator(CANONICAL_CONTENT_SCHEMA)

# TODO: replace with real DB/graph store
ENTITIES: Dict[str, Dict[str, Any]] = {}
RELATIONSHIPS: Dict[str, Dict[str, Any]] = {}
CANONICAL_CONTENT: Dict[str, Dict[str, Any]] = {}


def now_iso() -> str:
    return datetime.now(timezone.utc).isoformat()


def validate_or_400(validator: Draft7Validator, payload: Dict[str, Any]):
    errors = sorted(validator.iter_errors(payload), key=lambda e: e.path)
    if errors:
        raise HTTPException(status_code=400, detail=[e.message for e in errors])


@app.get("/health")
def health():
    return {"status": "ok"}


@app.post("/entities")
def create_entity(payload: Dict[str, Any]):
    # Assign server-side fields if omitted.
    entity_id = payload.get("id") or f"ent_{uuid.uuid4().hex}"
    payload["id"] = entity_id

    ts = now_iso()
    payload["createdAt"] = payload.get("createdAt") or ts
    payload["updatedAt"] = ts

    validate_or_400(entity_validator, payload)

    ENTITIES[entity_id] = payload
    return payload


@app.get("/entities/{id}")
def get_entity(id: str):
    entity = ENTITIES.get(id)
    if not entity:
        raise HTTPException(status_code=404, detail="Entity not found")
    return entity


@app.put("/canonical-content/{entityId}")
def put_canonical_content(entityId: str, payload: Dict[str, Any]):
    # Ensure entityId consistency
    payload["entityId"] = payload.get("entityId") or entityId
    if payload["entityId"] != entityId:
        raise HTTPException(status_code=400, detail="entityId in body must match path entityId")

    validate_or_400(canonical_content_validator, payload)

    CANONICAL_CONTENT[entityId] = payload
    return payload


@app.get("/canonical-content/{entityId}")
def get_canonical_content(entityId: str):
    content = CANONICAL_CONTENT.get(entityId)
    if not content:
        raise HTTPException(status_code=404, detail="CanonicalContent not found")
    return content


@app.post("/relationships")
def create_relationship(payload: Dict[str, Any]):
    validate_or_400(relationship_validator, payload)

    rel_id = payload.get("id") or f"rel_{uuid.uuid4().hex}"
    payload["id"] = rel_id
    RELATIONSHIPS[rel_id] = payload
    return payload


@app.get("/relationships")
def list_relationships(
    fromEntityId: Optional[str] = None,
    toEntityId: Optional[str] = None,
    type: Optional[str] = None,
):
    items = list(RELATIONSHIPS.values())

    if fromEntityId:
        items = [r for r in items if r.get("fromEntityId") == fromEntityId]
    if toEntityId:
        items = [r for r in items if r.get("toEntityId") == toEntityId]
    if type:
        items = [r for r in items if r.get("type") == type]

    return {"relationships": items}
